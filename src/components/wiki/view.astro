---
import Layout from '$layouts/wiki.astro'
import SidebarContentsSection from './sidebarContentsSection.astro'
import SidebarEventSection from './sidebarEventSection.astro'
import SidebarShareSection from './sidebarShareSection.astro'
import SidebarMetadataSection, {
  type Props as MetadataProps,
} from './sidebarMetadataSection.astro'

import dayjs from 'dayjs'

import type { FrontMatter } from '$functions/parseFrontMatter'
import type { ContentsgartenOutput } from '$types/ContentsgartenOutput'

export interface Props {
  pageRef: string
  title: string
  rendered: NonNullable<ContentsgartenOutput['view']['rendered']>
  parsedFrontMatter?: FrontMatter
  lastModified?: string
  lastModifiedBy?: string[]
  editable: boolean
}

const {
  pageRef,
  title,
  rendered,
  parsedFrontMatter,
  lastModified,
  lastModifiedBy,
  editable,
} = Astro.props

const metadata: MetadataProps = {
  edited: {
    at: dayjs(lastModified),
    by: lastModifiedBy ?? ['SYSTEM'],
  },
  editable,
  pageRef,
  grtn: parsedFrontMatter?.grtn,
}

const coverImage =
  parsedFrontMatter?.image ??
  (parsedFrontMatter?.event
    ? `https://assets.creatorsgarten.org/events/${pageRef.replace(
        'Events/',
        ''
      )}.png`
    : undefined)
---

<Layout title={title}>
  <Fragment slot="sidebar-left">
    {
      !!coverImage && (
        <img src={coverImage} class="aspect-square w-full" alt="cover image" />
      )
    }
    {
      !!parsedFrontMatter?.event && (
        <SidebarEventSection event={parsedFrontMatter.event} />
      )
    }
  </Fragment>

  <Fragment slot="sidebar-left-less-than-3-columns">
    <SidebarMetadataSection {...metadata} />
    <SidebarShareSection />
  </Fragment>

  <Fragment slot="sidebar-left-at-least-2-columns">
    <SidebarContentsSection contents={rendered.headings} />
  </Fragment>

  <Fragment slot="sidebar-right">
    <SidebarMetadataSection {...metadata} />
    <SidebarShareSection />
  </Fragment>

  <Fragment slot="sidebar-bottom">
    <SidebarMetadataSection {...metadata} />
    <SidebarShareSection />
  </Fragment>

  <slot />
</Layout>
