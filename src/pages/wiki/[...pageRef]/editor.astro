---
import Wiki from '$components/wiki.astro'
import { updateWiki } from '$functions/updateWiki'

let { pageRef } = Astro.params
if (pageRef === undefined) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  })
}

if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData()
    const pageRef = data.get('pageRef')
    const revision = data.get('revision')
    const content = data.get('content')

    if (pageRef && content) {
      await updateWiki(
        pageRef.toString(),
        content.toString(),
        (typeof revision === 'string' && revision) || undefined,
        Astro
      )

      return Astro.redirect(`/wiki/${pageRef}`)
    }
  } catch (e) {
    console.error(e)
  }
}
---

<Wiki mode="editor" pageRef={pageRef} />
