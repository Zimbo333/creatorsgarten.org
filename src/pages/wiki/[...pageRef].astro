---
import dayjs from 'dayjs'

import WikiLayout from '$layouts/wiki.astro'
import ContentRenderer from '$components/contentRenderer.astro'

import { getMarkdownFromSlug } from '$functions/getMarkdownFromSlug'

let { pageRef } = Astro.params

if (pageRef === undefined)
  pageRef = 'MainPage'
else if (pageRef === 'MainPage')
  return Astro.redirect('/wiki')
else if (pageRef.startsWith('Events/'))
  return Astro.redirect(`/event/${pageRef.replace('Events/', '')}`)

const markdown = await getMarkdownFromSlug(
  pageRef
)

if (markdown === null) {
  const { rewrite } = await import('$functions/rewrite')
  return rewrite(404, `${Astro.url.origin}/404`)
}

const { rendered, lastModified, lastModifiedBy } = markdown
---

<WikiLayout
  type="page"
  title={pageRef as string}
  contents={rendered.headings}
  metadata={{
    edited: {
      at: dayjs(lastModified).toDate(),
      by: (lastModifiedBy ?? ['System']).map(o => '@' + o).join(' '),
    },
  }}
>
  <ContentRenderer content={rendered.html} />
</WikiLayout>
