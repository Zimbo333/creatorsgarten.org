---
import dayjs from 'dayjs'

import WikiLayout from '$layouts/wiki.astro'
import { Markdown } from '@contentsgarten/markdown'

import { getMarkdownFromSlug } from '../../functions/getMarkdownFromSlug'
import { getMarkdownContent } from '../../functions/getMarkdownContent'

let { pageRef } = Astro.params

if (pageRef === undefined) {
  pageRef = 'MainPage'
} else if (pageRef === 'MainPage') {
  throw new Error('not-found')
}

const markdownResponse = await getMarkdownFromSlug(pageRef)
const { ids, rendered } = await getMarkdownContent(
  markdownResponse.result.data.file.content
)
---

<WikiLayout
  title={pageRef as string}
  contents={ids}
  metadata={{
    edited: {
      at: dayjs(markdownResponse.result.data.lastModified).toDate(),
      by: markdownResponse.result.data.lastModifiedBy.join(' '),
    },
  }}
>
  <Markdown text={rendered} />
</WikiLayout>
