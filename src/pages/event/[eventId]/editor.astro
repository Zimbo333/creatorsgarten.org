---
import Wiki from '$components/wiki.astro'
import { updateWiki } from '$functions/updateWiki'

let { eventId } = Astro.params

if (eventId === undefined) {
  const { rewrite } = await import('$functions/rewrite')
  return rewrite(404, `${Astro.url.origin}/404`)
}

if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData()
    const pageRef = data.get('pageRef')
    const revision = data.get('revision')
    const content = data.get('content')

    if (pageRef && content && revision) {
      await updateWiki(
        pageRef.toString(),
        content.toString(),
        revision.toString(),
        Astro
      )

      return Astro.redirect(`/wiki/${pageRef}`)
    }
  } catch (e) {
    console.error(e)
  }
}
---

<Wiki mode='editor' pageRef={`Events/${eventId}`} />
